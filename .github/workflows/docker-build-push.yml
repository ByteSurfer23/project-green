name: Build and Push Docker Image

on:
  push:
    branches:
      - main        # Runs automatically when you push to main
  workflow_dispatch: # Allows manual trigger from the Actions tab

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 🧩 Step 1: Checkout the repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 🔐 Step 2: Log in to Docker Hub
      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_TOKEN }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # 🏗️ Step 3: Build Docker image (use secrets as build args)
      - name: Build Docker image
        run: docker build \
          --build-arg MONGO_URL=${{ secrets.MONGO_URL }} \
          --build-arg PORT=${{ secrets.PORT }} \
          -t ${{ secrets.DOCKER_USERNAME }}/green-vit:latest ./backend

      # 📤 Step 4: Push Docker image to Docker Hub
      - name: Push Docker image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/my-backend:latest
